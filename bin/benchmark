#!/usr/bin/env ruby
# frozen_string_literal: true

# Set up LOAD_PATH with Bundler if needed
# require "bundler/setup"

# Load supporting libraries
require "fileutils"
require "time"

require "benchmark"
require "benchmark/ips"
require "stackprof"

# Load this gem
require_relative "../lib/dicey"
require_relative "../lib/dicey/cli/blender"

# Set up test data
# ...

# Run benchmark and generate reports
FileUtils.mkdir_p("tmp")
report_path = "tmp/benchmark #{Time.now.iso8601} " \
              "(#{`ruby -v`.chomp}) " \
              "(commit #{`git rev-parse HEAD`.chomp[0..7]}).json"
StackProf.run(mode: :cpu, raw: true, out: "tmp/stackprof.dump") do
  Benchmark.ips do |ips|
    ips.report("BruteForce") { Dicey::SumFrequencyCalculators::BruteForce.new.call(Dicey::RegularDie.from_count(6, 6)) }
    ips.report("Rolling") { Dicey::RegularDie.new(10_000).roll }
    ips.report("full run") { Dicey::CLI::Blender.new.call(["100d6", "--format", "null"]) }

    ips.json!(report_path)
  end
end
puts "Report saved to #{report_path}"

# Generate flamegraph to actually understand StackProf's report
`stackprof tmp/stackprof.dump --d3-flamegraph > tmp/flamegraph.html`
puts "Flamegraph saved to tmp/flamegraph.html"
